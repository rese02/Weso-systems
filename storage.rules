
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Default: Deny all access to Storage files.
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Allow agency/hoteliers to read/write hotel logos.
    match /hotels/logos/{fileName} {
        allow read: if true; // Logos are public
        allow write: if request.auth != null && (request.auth.token.role == 'agency' || request.auth.token.role == 'hotelier');
    }

    // Guest Document Uploads:
    // This is the most critical rule. It allows a user (even unauthenticated) to upload a file
    // ONLY if they are uploading into a path that contains a valid and active bookingLink ID.
    match /hotels/{hotelId}/bookings/{bookingId}/public/{linkId}/{fileName} {
      allow write: if 
                    // 1. Check if a bookingLink document with the given linkId exists in the correct hotel.
                    exists(/databases/$(database)/documents/hotels/$(hotelId)/bookingLinks/$(linkId)) &&
                    // 2. Check if the status of that link is 'active'.
                    get(/databases/$(database)/documents/hotels/$(hotelId)/bookingLinks/$(linkId)).data.status == 'active' &&
                    // 3. Check if the link has not expired.
                    get(/databases/$(database)/documents/hotels/$(hotelId)/bookingLinks/$(linkId)).data.expiresAt > request.time &&
                    // 4. Optionally, limit file size (e.g., 5MB).
                    request.resource.size < 5 * 1024 * 1024;
    }

    // Authenticated Access to Guest Documents:
    // Only the agency or the correct hotelier can READ documents after they've been uploaded.
    // Guests cannot read them back. Deletion is also restricted.
     match /hotels/{hotelId}/bookings/{bookingId}/public/{linkId}/{fileName} {
        allow read, delete: if request.auth != null && 
                            (request.auth.token.role == 'agency' || 
                             (request.auth.token.role == 'hotelier' && request.auth.token.hotelId == hotelId));
     }
  }
}
